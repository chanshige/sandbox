#! /usr/bin/env php
<?php
/**
 * フルSSLチェッカー
 */
require_once __DIR__ . "/../vendor/autoload.php";

use Facebook\WebDriver\Remote;
use Facebook\WebDriver\Chrome\ChromeOptions;

if (!isset($argv[1]) && !(bool)filter_var($argv[1], FILTER_VALIDATE_URL)) {
    throw new \Exception('Please input a sitemap url');
}

$xmlObject = @simplexml_load_string(file_get_contents($argv[1]));
if (!$xmlObject) {
    throw new \Exception('Error: Failed to load xml file.');
}

$options = (new ChromeOptions())->addArguments(array('--headless'));
$capabilities = Remote\DesiredCapabilities::chrome();
$capabilities->setCapability(ChromeOptions::CAPABILITY, $options);

/** @var Remote\RemoteWebDriver $driver */
$driver = Remote\RemoteWebDriver::create(
    'http://localhost:4444/wd/hub',
    $capabilities,
    5000
);

// Basic認証用
if (isset($argv[2]) && (bool)filter_var($argv[2], FILTER_VALIDATE_BOOLEAN)) {
    $driver->get($argv[1]);
}

echo "[SSL CHECK START]: --------------------------" . PHP_EOL;
$total = 0;
foreach ($xmlObject as $item) {
    $driver->get($item->loc);

    $mixedContent = preg_grep(
        '/.*Mixed Content.*/i',
        array_column(
            (array)$driver->manage()->getLog('browser'),
            'message')
    );

    echo "[URL] " . $item->loc . " [SSL] " . ((bool)$mixedContent ? 'NG' : 'OK') . PHP_EOL;
    // Error
    if (count($mixedContent) > 0) {
        echo '[ERROR DETAIL] ' . var_export($mixedContent, true) . PHP_EOL;
    }
    $total++;
}

/** Quits this driver */
$driver->quit();
echo "[TOTAL]: {$total}" . PHP_EOL;
echo "[SSL CHECK END]: --------------------------" . PHP_EOL;
